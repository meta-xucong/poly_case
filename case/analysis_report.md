# 运行现象综合分析报告（基于 case 日志与主界面快照）

## 1. 说明与范围

本报告基于以下数据来源进行汇总分析：

- `case/autorun_status.json`（运行状态汇总快照）
- `case/error_log.txt`、`case/exit_tokens.json`（聚合错误/退出原因统计）
- 典型 token 的 `autorun_*.log` 与 `autorun_exit_*.log`（问题复现样本）
- 用户提供的“主程序运行界面”文本快照

报告仅做运行状态分析，不包含代码修改。

---

## 2. 你提到的核心现象回顾与结论

### 2.1 REST API 获取 bid/ask 失败（`[FETCH][WARN]`）

**现象**：WS 数据过期后 fallback 到 REST，但 REST 仍无法返回 bid/ask。多次出现“尝试 1 个方法: get_order_book 仍失败”。

**判断**：
- 多为**外部依赖（Polymarket API/市场流动性）导致**，尤其在订单簿为空或流动性不足时。
- 该问题会导致价格更新频繁失败，进一步触发策略空转或退出。

**建议方向**：
- 降低 REST 依赖（提升 WS 数据新鲜度/订阅覆盖）。
- 对频繁失败的 token 设置更严格的流动性/数据有效性过滤。

---

### 2.2 卖出失败循环（`[MAKER][SELL] 下单失败，疑似仓位不足...`）

**现象**：在同步持仓后，卖出仍失败；且“缩减目标 → 立刻扩回”导致长期循环。

**判断**：
- **逻辑设计缺陷**：对可用仓位判断不严格，且缩减后又自动扩回导致无限重试。
- 可能存在“冻结仓位未扣除/挂单占用”导致实际可用仓位不足。

**建议方向**：
- 使用“可用仓位”而非“总持仓”驱动卖出。
- 连续不足时维持缩减目标，不要立刻扩回。

---

### 2.3 同步持仓后仍报仓位不足

**现象**：日志显示 `[STATE] 同步策略持仓 -> size=10` 后立刻出现卖出失败。

**判断**：
- **总持仓与可用仓位不一致**，或持仓数据来源与下单校验来源不同（data-api vs CLOB）。

**建议方向**：
- 以“可用份额”作为卖出依据，并在挂单前进行统一校验。

---

### 2.4 刚进入主循环即 `[EXIT] 最终状态`

**现象**：进入倒计时 sell-only 窗口但无持仓，脚本直接退出。

**判断**：
- 这是**正常策略行为**，非异常。

---

### 2.5 `[WS][SHARED] 启动30秒后仍未从缓存获取到token...`

**现象**：共享 WS 缓存中没有该 token 的数据，连续 3 分钟后退出。

**判断**：
- **聚合器订阅覆盖不足或订阅失败**。
- 亦可能为 WS/缓存组件异常或 token_id 未订阅。

**建议方向**：
- 校验聚合器订阅清单与缓存内容。
- 对缓存缺失 token 设置自动降级/退出机制，并加强告警。

---

### 2.6 exit-only cleanup 反复触发且“无持仓直接退出”

**现象**：同一 token 被重复拉起清仓任务，但每次无持仓即退出。

**判断**：
- **调度/队列清理机制未闭环**，导致 `pending_exit_topics` 残留。

**建议方向**：
- exit-only 任务完成后（无论是否有持仓）都应出队。
- 增加幂等或冷却机制，避免重复空跑。

---

## 3. 运行健康度与潜在问题总结（基于汇总文件）

### 3.1 整体运行规模与状态

- 已处理 token 数量较多（`handled_topics_total` 约 93）。
- 同时仍存在 `pending_topics` 队列（约 26）。
- `tasks` 中仍有多条 `running` 子进程，说明系统总体处于运行状态。

**结论**：系统总体“在跑”，但队列与退出机制存在潜在问题。

---

### 3.2 大量 `TOKEN_CLEANUP`（60分钟无更新）

**现象**：错误日志中大量 token 被清理，原因是 60 分钟无更新。

**判断**：
- 说明订阅 token 中存在大量低流动性市场或无行情市场。
- 会增加无效监控与退出频率。

**建议方向**：
- 增加流动性筛选策略，减少“无数据市场”的进入比例。

---

### 3.3 `AGGREGATOR_NO_DATA` 与 `STALE_DATA_IN_TRADING`

**现象**：多次出现聚合器无数据或运行中数据过期退出。

**判断**：
- 表示聚合器订阅覆盖不足或更新不稳定。
- 运行中退出说明市场可能失去流动性或 WS 数据更新中断。

---

## 4. 运行界面快照引出的专项问题

### 4.1 是否存在“长期卡死但不释放子进程”？

**结论**：
- 当前快照中，子进程均有最新 heartbeat，**不存在系统级“卡死”证据**。
- 但存在**逻辑空转/业务停滞**风险（例如：卖出失败循环、REST 反复失败等），这会降低效率但不算硬卡死。

---

### 4.2 “退出后允许再次进入”的机制是否生效？

**结论**：
- 从 `exit_tokens.json` 的 `refillable: true` 看，**设计上允许回流**。
- 但在 `pending_topics` 中未明显看到“退出后回流 token”，且 `pending_exit_topics` 仍残留，说明**可能未完全闭环**。
- 因此目前更倾向于“机制可能未完全生效或被 exit 队列阻塞”。

---

## 5. pending_topics 与 pending_exit_topics 的性质判断

- **pending_topics**：
  - 属于等待队列，**正常存在**。
  - 并发上限下，多余 token 必然处于 pending 状态。

- **pending_exit_topics**：
  - 理论上应在清理完成后出队。
  - 持续残留通常说明 exit-only 机制未闭环，**偏异常**。

---

## 6. 成因归类总结

### 6.1 Polymarket API 自身问题（外部依赖）

- REST API 获取 bid/ask 失败（尤其订单簿为空/限流）。
- WS 数据更新不稳定导致的缓存缺失。

### 6.2 逻辑设计缺陷

- 卖出失败后目标扩回导致循环。
- exit-only 清理任务不出队导致反复空跑。
- 可用仓位与总持仓混用。

### 6.3 代码实现问题

- 暂无直接证据指向“代码错误”，但部分逻辑缺陷可能需要通过代码修正实现。

---

## 7. 建议清单（不涉及改代码）

1. **聚合器订阅巡检**：定期比对订阅清单与缓存 token。
2. **清理队列闭环**：exit-only 任务完成后必须出队。
3. **可用仓位校验**：卖出前先确认 CLOB 可用份额。
4. **流动性筛选**：减少低流动性 token 进入。
5. **异常频发 token 降级**：REST/WS 多次失败直接退出或降低优先级。

---

## 8. 结论摘要

- 系统整体仍在运行，但存在**逻辑空转与退出队列残留**问题。
- `pending_topics` 的存在是正常队列现象；`pending_exit_topics` 长期残留偏异常。
- 关键风险集中在：**聚合器订阅覆盖不足、卖出失败循环、exit-only 清理不闭环**。

